---
title: "Analysis of U.S. Storm Event Data and the Impact on Population Health and the Economy"
author: "Jeffrey Hunter"
date: "4/26/2019"
output:
  html_document:
    df_print: paged
  pdf_document: default
  html_notebook: default
  pdf_notebook: default
---

## Table of Contents

[Synonpsis](#synonpsis)<br />
[Set Up Environment](#set-up-environment)<br />
[Load Data](#load-data)<br />
[Data Processing](#data-processing)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Create Subset of Data](#create-subset-of-data)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Clean Event Type Data](#clean-event-type-data)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Clean Date Data](#clean-date-data)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Clean Economic Data](#clean-economic-data)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Summarize Data](#summarize-data)<br />
[Results](#results)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Event Types Most Harmful to Population Health](#event-types-most-harmful-to-population-health)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Event Types with Greatest Economic Consequences](#event-types-with-greatest-economic-consequences)<br />
[Conclusion](#conclusion)

## Synonpsis

Storms and other severe weather events can cause both public health and economic
problems for communities and municipalities. Many severe events can result in
fatalities, injuries, and property damage, and preventing such outcomes to the
extent possible is a key concern.

This report contains the results of an analysis where the goal was to identify
the most hazardous weather events with respect to population health and those
with the greatest economic impact in the U.S. based on data collected from the
U.S. National Oceanic and Atmospheric Administration's (NOAA).

The storm database includes weather events from 1950 through the year 2011 and
contains data estimates such as the number fatalities and injuries for each
weather event as well as economic damage on properties and crops.

The estimates for fatalities, injuries, property and crop damage were used
to determine the most harmful impact to both population health and the economy.

## Set Up Environment

Disable warnings

```{r setup, include = TRUE}
knitr::opts_chunk$set(echo = FALSE)
```

Load libraries

```{r, echo = TRUE}
options(scipen = 1) # disable scientific notation for numbers
library(dplyr, warn.conflicts = FALSE)
library(ggplot2)
```

Session information

```{r, echo = TRUE}
sessionInfo()
```

## Load Data

Download the compressed data file from the source URL (if not found locally) and
then load the compressed data file via `read.csv`. Prior to processing
the data, validate the downloaded data file and loaded dataset by checking the file 
size and dimensions respectively.

```{r, echo = TRUE, cache = TRUE}
setwd("~jhunter/repos/coursera/reproducible-research-course-project-2")
stormDataFileURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
stormDataFile <- "data/storm-data.csv.bz2"
if (!file.exists('data')) {
    dir.create('data')
}
if (!file.exists(stormDataFile)) {
    download.file(url = stormDataFileURL, destfile = stormDataFile)
}
stormData <- read.csv(stormDataFile, sep = ",", header = TRUE)
stopifnot(file.size(stormDataFile) == 49177144) 
stopifnot(dim(stormData) == c(902297,37))
```

Display dataset summary

```{r, echo = TRUE}
names(stormData)
```

```{r, echo = TRUE}
str(stormData)
```

```{r, echo = TRUE}
head(stormData)
```

## Data Processing

### Create Subset of Data

When processing a large dataset, compute performance can be improved by taking a
subset of the variables associated to population health and economy damage. For
this analysis, the dataset will be trimmed to only include the necessary
variables (listed below). In addition, only observations with `value > 0` will
be included.

| Variable     | Description                                                |
|--------------|------------------------------------------------------------|
| EVTYPE       | Event type (Flood, Heat, Hurricane, Tornado, ...)          |
| FATALITIES   | Number of fatalities resulting from event                  |
| INJURIES     | Number of injuries resulting from event                    |
| PROPDMG      | Property damage in USD                                     |
| PROPDMGEXP   | Unit multiplier for property damage (-, +, H, K, M, or B)  |
| CROPDMG      | Crop damage in USD                                         |
| CROPDMGEXP   | Unit multiplier for property damage (-, +, H, K, M, or B)  |
| BGN_DATE     | Begin date of the event                                    |
| END_DATE     | End date of the event                                      |
| STATE        | State where the event occurred                             |

```{r, echo = TRUE}
stormDataTidy <- subset(stormData, EVTYPE != "?"
                                   &
                                   (FATALITIES > 0 | INJURIES > 0 | PROPDMG > 0 | CROPDMG > 0),
                                   select = c("EVTYPE",
                                              "FATALITIES",
                                              "INJURIES", 
                                              "PROPDMG",
                                              "PROPDMGEXP",
                                              "CROPDMG",
                                              "CROPDMGEXP",
                                              "BGN_DATE",
                                              "END_DATE",
                                              "STATE"))
dim(stormDataTidy)
sum(is.na(stormDataTidy))
```

The working (tidy) dataset contains 254632 observations, 10 variables and no
missing values.

### Clean Event Type Data

There are a total of 487 unique Event Type values in the current tidy dataset.

```{r, echo = TRUE}
length(unique(stormDataTidy$EVTYPE))
```

Exploring the Event Type data revealed many values that appeared to be similar;
however, they were entered with different spellings, pluralization, mixed
case and even misspellings. For example, `Strong Wind`, `STRONG WIND`,
`Strong Winds`, and `STRONG WINDS`.

The dataset was normalized by converting all Event Type values to uppercase and
combining similar Event Type values into unique categories.

```{r, echo = TRUE}
stormDataTidy$EVTYPE <- toupper(stormDataTidy$EVTYPE)
```

```{r, echo = TRUE}
# AVALANCHE
stormDataTidy$EVTYPE <- gsub('.*AVALANCE.*', 'AVALANCHE', stormDataTidy$EVTYPE)

# BLIZZARD
stormDataTidy$EVTYPE <- gsub('.*BLIZZARD.*', 'BLIZZARD', stormDataTidy$EVTYPE)

# CLOUD
stormDataTidy$EVTYPE <- gsub('.*CLOUD.*', 'CLOUD', stormDataTidy$EVTYPE)

# COLD
stormDataTidy$EVTYPE <- gsub('.*COLD.*', 'COLD', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*FREEZ.*', 'COLD', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*FROST.*', 'COLD', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*ICE.*', 'COLD', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*LOW TEMPERATURE RECORD.*', 'COLD', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*LO.*TEMP.*', 'COLD', stormDataTidy$EVTYPE)

# DRY
stormDataTidy$EVTYPE <- gsub('.*DRY.*', 'DRY', stormDataTidy$EVTYPE)

# DUST
stormDataTidy$EVTYPE <- gsub('.*DUST.*', 'DUST', stormDataTidy$EVTYPE)

# FIRE
stormDataTidy$EVTYPE <- gsub('.*FIRE.*', 'FIRE', stormDataTidy$EVTYPE)

# FLOOD
stormDataTidy$EVTYPE <- gsub('.*FLOOD.*', 'FLOOD', stormDataTidy$EVTYPE)

# FOG
stormDataTidy$EVTYPE <- gsub('.*FOG.*', 'FOG', stormDataTidy$EVTYPE)

# HAIL
stormDataTidy$EVTYPE <- gsub('.*HAIL.*', 'HAIL', stormDataTidy$EVTYPE)

# HEAT
stormDataTidy$EVTYPE <- gsub('.*HEAT.*', 'HEAT', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*WARM.*', 'HEAT', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*HIGH.*TEMP.*', 'EXTREME HEAT', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*RECORD HIGH TEMPERATURES.*', 'EXTREME HEAT', stormDataTidy$EVTYPE)

# HYPOTHERMIA/EXPOSURE
stormDataTidy$EVTYPE <- gsub('.*HYPOTHERMIA.*', 'HYPOTHERMIA/EXPOSURE', stormDataTidy$EVTYPE)

# LANDSLIDE
stormDataTidy$EVTYPE <- gsub('.*LANDSLIDE.*', 'LANDSLIDE', stormDataTidy$EVTYPE)

# LIGHTNING
stormDataTidy$EVTYPE <- gsub('^LIGHTNING.*', 'LIGHTNING', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('^LIGNTNING.*', 'LIGHTNING', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('^LIGHTING.*', 'LIGHTNING', stormDataTidy$EVTYPE)

# MICROBURST
stormDataTidy$EVTYPE <- gsub('.*MICROBURST.*', 'MICROBURST', stormDataTidy$EVTYPE)

# MUDSLIDE
stormDataTidy$EVTYPE <- gsub('^MUDSLIDE.*', 'MUDSLIDE', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('^MUD SLIDE.*', 'MUDSLIDE', stormDataTidy$EVTYPE)

# RAIN
stormDataTidy$EVTYPE <- gsub('.*RAIN.*', 'RAIN', stormDataTidy$EVTYPE)

# RIP CURRENT
stormDataTidy$EVTYPE <- gsub('.*RIP CURRENT.*', 'RIP CURRENT', stormDataTidy$EVTYPE)

# STORM
stormDataTidy$EVTYPE <- gsub('.*STORM.*', 'STORM', stormDataTidy$EVTYPE)

# SUMMARY
stormDataTidy$EVTYPE <- gsub('.*SUMMARY.*', 'SUMMARY', stormDataTidy$EVTYPE)

# TORNADO
stormDataTidy$EVTYPE <- gsub('.*TORNADO.*', 'TORNADO', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*TORNDAO.*', 'TORNADO', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*LANDSPOUT.*', 'TORNADO', stormDataTidy$EVTYPE)

# SURF
stormDataTidy$EVTYPE <- gsub('.*SURF.*', 'SURF', stormDataTidy$EVTYPE)

# VOLCANIC
stormDataTidy$EVTYPE <- gsub('.*VOLCANIC.*', 'VOLCANIC', stormDataTidy$EVTYPE)

# WATERSPOUT
stormDataTidy$EVTYPE <- gsub('.*WATERSPOUT.*', 'WATERSPOUT', stormDataTidy$EVTYPE)

# WET
stormDataTidy$EVTYPE <- gsub('.*WET.*', 'WET', stormDataTidy$EVTYPE)

# WIND
stormDataTidy$EVTYPE <- gsub('.*WIND.*', 'WIND', stormDataTidy$EVTYPE)

# WINTER
stormDataTidy$EVTYPE <- gsub('.*WINTER.*', 'WINTER', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*WINTRY.*', 'WINTER', stormDataTidy$EVTYPE)
stormDataTidy$EVTYPE <- gsub('.*SNOW.*', 'WINTER', stormDataTidy$EVTYPE)
```

After tidying the dataset, the number of unique Event Type values were reduced
to 83.

```{r, echo = TRUE}
length(unique(stormDataTidy$EVTYPE))
```

### Clean Date Data

Format date variables for any type of optional reporting or further analysis.

In the raw dataset, the `BNG_START` and `END_DATE` variables are stored as
factors which should be made available as actual *date* types that can be
manipulated and reported on. For now, time variables will be ignored.

Create four new variables based on date variables in the tidy dataset:

| Variable     | Description                                   |
|--------------|-----------------------------------------------|
| DATE_START   | Begin date of the event stored as a date type |
| DATE_END     | End date of the event stored as a date type   |
| YEAR         | Year the event started                        |
| DURATION     | Duration (in hours) of the event              |

```{r, echo = TRUE}
stormDataTidy$DATE_START <- as.Date(stormDataTidy$BGN_DATE, format = "%m/%d/%Y")
stormDataTidy$DATE_END <- as.Date(stormDataTidy$END_DATE, format = "%m/%d/%Y")
stormDataTidy$YEAR <- as.integer(format(stormDataTidy$DATE_START, "%Y"))
stormDataTidy$DURATION <- as.numeric(stormDataTidy$DATE_END - stormDataTidy$DATE_START)/3600
```

### Clean Economic Data

According to the
"National Weather Service [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)"
(page 12), information about Property Damage is logged using two variables:
`PROPDMG` and `PROPDMGEXP`. `PROPDMG` is the mantissa (significand) rounded to
three significant digits and `PROPDMGEXP` is the exponent (the multiplier). The
same approach is used for Crop Damage where the `CROPDMG` variable is encoded by
the `CROPDMGEXP` variable.

The documentation also specifies that the `PROPDMGEXP` and `CROPDMGEXP` are
supposed to contain an alphabetical character used to signify magnitude and
includes "K" for thousands, "M" for millions, and "B" for billions. A quick
review of the data, however, shows that there are several other characters
being logged.

```{R, echo = TRUE}
table(toupper(stormDataTidy$PROPDMGEXP))
table(toupper(stormDataTidy$CROPDMGEXP))
```

In order to calculate costs, the `PROPDMGEXP` and `CROPDMGEXP` variables
will be mapped to a multiplier factor which will then be used to calculate the
actual costs of both property and crop damage. Three new variables will be
created to store damage costs:

* PROP_COST
* CROP_COST
* TOTAL_COST

```{R, echo = TRUE}
# function to get multiplier factor
getMultiplier <- function(exp) {
    exp <- toupper(exp);
    if (exp == "")  return (10^0);
    if (exp == "-") return (10^0);
    if (exp == "?") return (10^0);
    if (exp == "+") return (10^0);
    if (exp == "0") return (10^0);
    if (exp == "1") return (10^1);
    if (exp == "2") return (10^2);
    if (exp == "3") return (10^3);
    if (exp == "4") return (10^4);
    if (exp == "5") return (10^5);
    if (exp == "6") return (10^6);
    if (exp == "7") return (10^7);
    if (exp == "8") return (10^8);
    if (exp == "9") return (10^9);
    if (exp == "H") return (10^2);
    if (exp == "K") return (10^3);
    if (exp == "M") return (10^6);
    if (exp == "B") return (10^9);
    return (NA);
}

# calculate property damage and crop damage costs
stormDataTidy$PROP_COST <- with(stormDataTidy, as.numeric(PROPDMG) * sapply(PROPDMGEXP, getMultiplier))
stormDataTidy$CROP_COST <- with(stormDataTidy, as.numeric(CROPDMG) * sapply(CROPDMGEXP, getMultiplier))
stormDataTidy$TOTAL_COST <- stormDataTidy$PROP_COST + stormDataTidy$CROP_COST
```

### Summarize Data

```{R, echo = TRUE}
populationHealthData <- aggregate(x = list(healthImpact = stormDataTidy$FATALITIES + stormDataTidy$INJURIES), 
                                  by = list(EVENT_TYPE = stormDataTidy$EVTYPE), 
                                  FUN = sum,
                                  na.rm = TRUE)
populationHealthData <- populationHealthData[order(populationHealthData$healthImpact, decreasing = TRUE),]
```

## Results

### Event Types Most Harmful to Population Health

```{R, echo = TRUE}
healthImpactChart <- ggplot(head(populationHealthData, 10),
                            geom_bar(stat = "identity") + 
                            aes(x = reorder(EVENT_TYPE, healthImpact), y = healthImpact, fill = EVENT_TYPE)) +
                            coord_flip() +
                            xlab("Event Type") +
                            ylab("Total Fatalities and Injures") + 
                            ggtitle("Top 10 Weather Events Most Harmful to Population Health in U.S.")
print(healthImpactChart)
```


### Event Types with Greatest Economic Consequences



## Conclusion

Based on the evidence demonstrated in this analysis and supported by the
included data and graphs, the following conclusions can be drawn:

* **Which types of weather events are most harmful to population health?**

Tornadoes are responsible for the greatest number of fatalities and injuries.

* **Which types of weather events have the greatest economic consequences?**

Floods are the weather event that cause most Property Damage, followed by hurricanes.

Drought are the weather event that causes most crop damages, followed by flood.


--------------
From these data and graphs, we found that Tornado are most harmful with respect to population health, while Flood have the greatest economic consequences.


The results in this report found that tornadoes were most
harmful with respect to population health, while floods had the greatest economic
impact.

4.1 - Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

Tornado was the most harmful weather event type in terms of population health.

4.2 - Across the United States, which types of events have the greatest economic consequences?

Flood was the worst weather event type in terms of economic consequences.

The analysis shows Tornado was the most harmful weather event type in terms of population health while Flood was the weather event type had the worst economic impact.
